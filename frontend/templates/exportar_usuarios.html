<!-- templates/exportar_usuarios.html -->

{% extends 'base.html' %}

{% block title %}Exportar Usuarios{% endblock %}

{% block content %}
  <h1>Exportar Usuarios</h1>
  <button id="btn-exportar" class="btn btn-success">Descargar CSV</button>
  <div id="export-status" class="mt-2"></div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('btn-exportar').addEventListener('click', async function() {
    const resp = await fetch('/users/api/usuarios/exportar/', {
      method: 'GET',
      credentials: 'include'
    });
    if (resp.status === 401 || resp.status === 403) {
      window.location.href = '/dashboard/login-page/';
      return;
    }
    if (resp.status === 200) {
      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'usuarios.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      document.getElementById('export-status').textContent = 'Descarga completa.';
    } else {
      document.getElementById('export-status').textContent = 'Error al exportar.';
    }
  });
</script>
{% endblock %}
