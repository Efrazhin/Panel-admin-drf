{% extends 'base.html' %}

{% block title %}Permisos para Rol: {{ rol_nombre }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin-top: 20px;">
  <h1>Asignar Permisos al Rol: {{ rol_nombre }}</h1>

  <div id="alert-error" class="alert alert-danger" style="display: none;"></div>
  <div id="alert-success" class="alert alert-success" style="display: none;"></div>

  <form id="rol-permisos-form">
    <div class="form-group">
      <label for="permisos-select">Selecciona Permisos</label>
      <select id="permisos-select" class="form-control" multiple size="10">
        <!-- Las <option> se llenarán dinámicamente con JS -->
      </select>
      <small id="error-permisos" class="text-danger"></small>
    </div>

    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    <button type="button" class="btn btn-secondary" id="btn-cancelar">Cancelar</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const rolId = {{ rol_id }};
    const alertError = document.getElementById('alert-error');
    const alertSuccess = document.getElementById('alert-success');
    const permisosSelect = document.getElementById('permisos-select');

    // 1) Obtener todos los permisos disponibles
    let todosPermisos = [];
    try {
      const respPerms = await fetch('/users/api/permisos/', {
        method: 'GET',
        credentials: 'include'
      });
      if (respPerms.status === 401 || respPerms.status === 403) {
        window.location.href = '/dashboard/acceso-denegado/';
        return;
      }
      const dataPerms = await respPerms.json();
      if (respPerms.status !== 200) {
        alertError.textContent = dataPerms.detail || 'Error al cargar permisos.';
        alertError.style.display = 'block';
        return;
      }
      todosPermisos = dataPerms; // arreglo de objetos {id, codename, name, content_type}
    } catch (error) {
      alertError.textContent = 'Error de conexión al cargar permisos.';
      alertError.style.display = 'block';
      console.error(error);
      return;
    }

    // 2) Obtener permisos actuales del rol
    let permisosRol = [];
    try {
      const respRol = await fetch(`/users/api/roles/${rolId}/`, {
        method: 'GET',
        credentials: 'include'
      });
      if (respRol.status === 401 || respRol.status === 403) {
        window.location.href = '/dashboard/acceso-denegado/';
        return;
      }
      const dataRol = await respRol.json();
      // dataRol.permisos es un array de objetos PermissionSerializer (con id, codename, name, content_type)
      permisosRol = dataRol.permisos.map(p => p.id);
    } catch (error) {
      alertError.textContent = 'Error al cargar permisos del rol.';
      alertError.style.display = 'block';
      console.error(error);
      return;
    }

    // 3) Llenar el <select multiple> con todos los permisos,
    //    marcando como selected los que ya tiene el rol
    todosPermisos.forEach(perm => {
      const option = document.createElement('option');
      option.value = perm.id;
      option.textContent = `${perm.codename} — ${perm.name}`;
      if (permisosRol.includes(perm.id)) {
        option.selected = true;
      }
      permisosSelect.appendChild(option);
    });

    // 4) Manejar el envío del formulario
    document.getElementById('rol-permisos-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      alertError.style.display = 'none';
      alertSuccess.style.display = 'none';

      // Recoger IDs seleccionados
      const selectedOptions = Array.from(permisosSelect.selectedOptions).map(opt => parseInt(opt.value));

      // Validar que no esté vacío (si querés permitir que un rol quede sin permisos, quita esta validación)
      if (selectedOptions.length === 0) {
        document.getElementById('error-permisos').textContent = 'Debes seleccionar al menos un permiso.';
        return;
      }

      try {
        const respUpdate = await fetch(`/users/api/roles/${rolId}/permisos/`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ permisos_ids: selectedOptions })
        });
        const dataUpdate = await respUpdate.json();
        if (respUpdate.status === 200) {
          alertSuccess.textContent = 'Permisos del rol actualizados correctamente.';
          alertSuccess.style.display = 'block';
        } else if (respUpdate.status === 400) {
          document.getElementById('error-permisos').textContent = dataUpdate.permisos_ids 
            ? dataUpdate.permisos_ids[0] 
            : 'Error al actualizar.';
        } else if (respUpdate.status === 403) {
          window.location.href = '/dashboard/acceso-denegado/';
        } else {
          alertError.textContent = dataUpdate.detail || 'Error inesperado al actualizar permisos.';
          alertError.style.display = 'block';
        }
      } catch (error) {
        alertError.textContent = 'Error de conexión al actualizar permisos.';
        alertError.style.display = 'block';
        console.error(error);
      }
    });

    // 5) Botón “Cancelar” vuelve al listado de roles
    document.getElementById('btn-cancelar').addEventListener('click', () => {
      window.location.href = '/dashboard/roles/';
    });
  });
</script>
{% endblock %}
