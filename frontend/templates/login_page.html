<!-- templates/login_page.html -->

{% extends 'base.html' %}

{% block title %}Iniciar Sesión{% endblock %}

{% block content %}
  <h1>Iniciar Sesión</h1>
  <form id="login-form">
    <div class="form-group">
      <label for="email">Correo Electrónico</label>
      <input type="email" id="email" name="email" class="form-control" required>
    </div>
    <div class="form-group">
      <label for="password">Contraseña</label>
      <input type="password" id="password" name="password" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
  </form>
  <div id="login-error" class="text-danger mt-2" style="display: none;"></div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errDiv = document.getElementById('login-error');
    
    try {
      // Crear FormData en lugar de JSON
      const formData = new FormData();
      formData.append('email', email);
      formData.append('password', password);

      const resp = await fetch('/users/api/login/', {
        method: 'POST',
        credentials: 'include',  // Importante para manejar cookies
        body: formData  // Enviar como FormData
      });
      
      const data = await resp.json();
      
      if (resp.status === 200) {
        // Login exitoso
        errDiv.style.display = 'none';
        
        // Esperar un momento para asegurar que las cookies se establezcan
        setTimeout(() => {
          // Redirigir siempre al dashboard principal
          window.location.href = '/dashboard/dashboard/';
        }, 100);
      } else {
        // Mostrar error
        errDiv.textContent = data.detail || 'Error en el login';
        errDiv.style.display = 'block';
      }
    } catch (error) {
      // Error de red o servidor
      errDiv.textContent = 'Error de conexión. Por favor, intente nuevamente.';
      errDiv.style.display = 'block';
      console.error('Error:', error);
    }
  });
</script>
{% endblock %}
