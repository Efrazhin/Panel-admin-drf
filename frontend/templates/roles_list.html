{% extends 'base.html' %}

{% block title %}Roles{% endblock %}

{% block content %}
  <div class="container" style="margin-top: 20px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Listado de Roles</h1>

      {# El botón “Crear Rol” solo aparece si 'add_rol' está en user_perms #}
      {% if 'add_rol' in user_perms %}
        <button id="btn-crear-rol" class="btn btn-success">Crear Rol</button>
      {% endif %}
    </div>

    <div id="tabla-roles">
      <!-- Aquí irá la tabla que genere el JS -->
    </div>
  </div>

  {{ user_perms|json_script:"userPerms" }}
{% endblock %}


{% block extra_js %}
<script>
  async function cargarRoles() {
    const resp = await fetch('/users/api/roles/', {
      method: 'GET',
      credentials: 'include'
    });
    if (resp.status === 401 || resp.status === 403) {
      window.location.href = '/dashboard/login-page/';
      return;
    }
    const data = await resp.json();

    const cont = document.getElementById('tabla-roles');
    cont.innerHTML = '';

    // Creamos la tabla básica
    const tabla = document.createElement('table');
    tabla.classList.add('table', 'table-striped');
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Acciones</th>
      </tr>
    `;
    tabla.appendChild(thead);

    const tbody = document.createElement('tbody');
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.nombre}</td>
        <td>
          ${ window.user_perms.includes('change_rol')
             ? `<button class="btn btn-sm btn-info btn-editar" data-id="${r.id}">Editar</button>`
             : ''
          }
          ${ window.user_perms.includes('delete_rol')
             ? `<button class="btn btn-sm btn-danger btn-eliminar" data-id="${r.id}">Eliminar</button>`
             : ''
          }
          ${ window.user_perms.includes('change_rol')
             ? `<button class="btn btn-sm btn-warning btn-asignar" data-id="${r.id}">Asignar Permisos</button>`
             : ''
          }
        </td>
      `;
      tbody.appendChild(tr);
    });
    tabla.appendChild(tbody);
    cont.appendChild(tabla);

    // Asignamos eventos a los botones generados
    document.querySelectorAll('.btn-editar').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        window.location.href = `/dashboard/roles/form/${id}/`;
      });
    });

    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('¿Seguro que deseas eliminar este rol?')) return;

        const respDel = await fetch(`/users/api/roles/${id}/`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (respDel.status === 204) {
          cargarRoles();
        } else if (respDel.status === 403) {
          alert('No tienes permiso para eliminar este rol.');
        } else {
          alert('Error al eliminar.');
        }
      });
    });

    document.querySelectorAll('.btn-asignar').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        window.location.href = `/dashboard/roles/${id}/permisos/`;
      });
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Leemos user_perms desde el <script> generado por json_script
    window.user_perms = JSON.parse(document.getElementById('userPerms').textContent);
    cargarRoles();

    const btnCrear = document.getElementById('btn-crear-rol');
    if (btnCrear) {
      btnCrear.addEventListener('click', () => {
        window.location.href = '/dashboard/roles/form/';
      });
    }
  });
</script>
{% endblock %}
