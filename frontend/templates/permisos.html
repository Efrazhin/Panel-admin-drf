{% extends 'base.html' %}

{% block title %}Permisos{% endblock %}

{% block content %}
  <div class="container" style="margin-top: 20px;">
    <h1>Listado de Permisos</h1>

    <div id="alert-error" class="alert alert-danger" style="display: none;"></div>

    <table class="table table-striped table-bordered mt-4">
      <thead class="thead-dark">
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Codename</th>
          <th scope="col">Nombre</th>
          <th scope="col">Content Type</th>
        </tr>
      </thead>
      <tbody id="permissions-body">
        <!-- Aquí el JS insertará las filas -->
      </tbody>
    </table>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const alertError = document.getElementById('alert-error');
    const tbody = document.getElementById('permissions-body');

    try {
      const resp = await fetch('/users/api/permisos/', {
        method: 'GET',
        credentials: 'include',  // Para enviar la cookie JWT
      });

      if (resp.status === 401 || resp.status === 403) {
        // Si no está autorizado, redirigimos a “Acceso Denegado”
        window.location.href = '/dashboard/acceso-denegado/';
        return;
      }

      const data = await resp.json();

      if (resp.status !== 200) {
        // Si hay otro error, mostrar mensaje
        alertError.textContent = data.detail || 'Error al cargar los permisos.';
        alertError.style.display = 'block';
        return;
      }

      // data es un arreglo de objetos { id, codename, name, content_type }
      data.forEach(perm => {
        const tr = document.createElement('tr');

        // ID
        const tdId = document.createElement('td');
        tdId.textContent = perm.id;
        tr.appendChild(tdId);

        // Codename
        const tdCodename = document.createElement('td');
        tdCodename.textContent = perm.codename;
        tr.appendChild(tdCodename);

        // Nombre
        const tdName = document.createElement('td');
        tdName.textContent = perm.name;
        tr.appendChild(tdName);

        // Content Type (puede venir como objeto o como ID; adaptamos)
        const tdContentType = document.createElement('td');
        // Si viene anidado (serializado), puede estar en perm.content_type.model o perm.content_type.id
        if (perm.content_type && perm.content_type.model) {
          tdContentType.textContent = perm.content_type.model;
        } else {
          tdContentType.textContent = perm.content_type;
        }
        tr.appendChild(tdContentType);

        tbody.appendChild(tr);
      });
    } catch (error) {
      alertError.textContent = 'Error de conexión. Intenta nuevamente.';
      alertError.style.display = 'block';
      console.error('Error al obtener permisos:', error);
    }
  });
</script>
{% endblock %}
